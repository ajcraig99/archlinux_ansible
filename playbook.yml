---
- name: Arch Linux Setup
  hosts: localhost
  connection: local
  
  # ----------------------------------------------------------------
  # VARIABLES: Edit these lists to customize your setup
  # ----------------------------------------------------------------
  vars:
    # 1. The folder where your dotfiles are currently located (Source)
    #    If you cloned your repo to ~/dotfiles, leave as is.
    dotfiles_dir: "/home/{{ ansible_facts.user_id }}/dotfiles"
    dotfiles_repo_url: "https://github.com/ajcraig99/nixos_hyprland.git" 

    # 2. Official Arch Packages (Pacman)
    pacman_packages:

# --- System / Build ---
      - base-devel
      - go
      - git
      - neovim
      - tree
      - fastfetch
      - btop
      - unzip
      - man-db
      - usbutils
      - bluez
      - bluez-utils
      - wget
      - nwg-displays
      - networkmanager 

      # --- Audio / Media ---
      - pipewire
      - pipewire-pulse
      - pavucontrol
      - ffmpeg
      - vlc
      - mpv
      - gthumb
      - loupe
      - gimp
      - inkscape
      - yt-dlp

      # --- Hyprland & Wayland Core ---
      - hyprland
      - hyprpaper
      - hyprlock
      - hypridle
      - waybar
      - rofi-wayland          
      - swaync               
      - wl-clipboard
      - grim
      - slurp
      - libnotify
      - playerctl

      # --- File Management ---
      - dolphin
      - nemo
      - nemo-fileroller       
      - file-roller          
      - gvfs
      - tumbler
      - webp-pixbuf-loader

      # --- Shell / Terminal ---
      - kitty
      - zsh
      - zsh-autosuggestions
      - zsh-syntax-highlighting
      - fzf
      - bat
      - eza
      - ttf-jetbrains-mono-nerd

      # --- Apps ---
      - firefox
      - discord
      - steam
      - obsidian
      - gnome-calendar
      - simple-scan
      - jq
      - socat

    # 3. AUR Packages (Yay)
    aur_packages:
      - google-chrome
      - visual-studio-code-bin
      - vesktop-bin
      - smath
      - wlogout
      - grimblast-git
      - onlyoffice-bin
      - peazip-qt-bin
      - waybar-module-pacman-updates-git
      - zsh-theme-powerlevel10k-git

      # --- Theming ---
      - catppuccin-gtk-theme-mocha
      - catppuccin-cursors-mocha
      - dracula-gtk-theme
      - dracula-icons-git
    symlinks:
# Folders
      - { src: '.config/hypr',      dest: '.config/hypr' }
      - { src: '.config/waybar',    dest: '.config/waybar' }
      - { src: '.config/rofi',      dest: '.config/rofi' }
      - { src: '.config/kitty',     dest: '.config/kitty' }
      - { src: '.config/fastfetch', dest: '.config/fastfetch' }
      - { src: '.config/nemo',      dest: '.config/nemo' }
      - { src: '.config/wlogout',   dest: '.config/wlogout' }
      - { src: '.config/wallpapers', dest: '.config/wallpapers' }
      
      # Individual Files
      - { src: '.zshrc',            dest: '.zshrc' }
      - { src: '.p10k.zsh',         dest: '.p10k.zsh' }

  # ----------------------------------------------------------------
  # TASKS: The logic that applies the variables above
  # ----------------------------------------------------------------
  tasks:

   # --- PRE-REQ: Enable Multilib (Needed for Steam) ---
    - name: Enable Multilib repository
      become: true
      replace:
        path: /etc/pacman.conf
        regexp: '^#\[multilib\]\n#Include = /etc/pacman.d/mirrorlist'
        replace: '[multilib]\nInclude = /etc/pacman.d/mirrorlist'

    # --- PRE-REQ: Remove PulseAudio (Conflicts with Pipewire) ---
    - name: Remove conflicting PulseAudio packages
      become: true
      community.general.pacman:
        name:
          - pulseaudio
          - pulseaudio-alsa
          - pulseaudio-bluetooth
        state: absent
        force: yes

    # --- STEP 1: Install Official Packages ---
    - name: Install Pacman packages
      become: true  # Requires sudo
      community.general.pacman:
        name: "{{ pacman_packages }}"
        state: present
        update_cache: true

    # --- PRE-REQ: Install Yay (AUR Helper) ---
    - name: Check if yay is installed
      command: which yay
      register: yay_check
      ignore_errors: true
      changed_when: false

    - name: Clone yay AUR repo
      git:
        repo: https://aur.archlinux.org/yay.git
        dest: /tmp/yay
      when: yay_check.rc != 0

    - name: Build and install yay
      command: makepkg -s --noconfirm
      args:
        chdir: /tmp/yay
      when: yay_check.rc != 0
      become: false

    - name: Install yay (install binary)
      shell: pacman -U --noconfirm *.pkg.tar.zst
      args:
        chdir: /tmp/yay
      when: yay_check.rc != 0
      become: true

    # --- Clone Dotfiles
    - name: Clone Dotfiles Repository
      git:
        repo: "{{ dotfiles_repo_url }}"
        dest: "{{ dotfiles_dir }}"
        update: yes
        force: yes

    # 1. Allow 'sudo pacman' without a password temporarily
    - name: Allow passwordless sudo for pacman
      become: true
      lineinfile:
        path: /etc/sudoers.d/10-ansible-pacman
        line: "{{ ansible_facts.user_id }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    # --- STEP 2: Install AUR Packages ---
    - name: Install AUR packages
      kewlfft.aur.aur:
        name: "{{ aur_packages }}"
        use: yay
        state: present

    # 3. Clean up the permission file
    - name: Remove passwordless sudo for pacman
      become: true
      file:
        path: /etc/sudoers.d/10-ansible-pacman
        state: absent
# --- STEP 3: Create Directories ---
    - name: Ensure parent directories for configs exist
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item.dest | dirname }}"
        state: directory
        mode: '0755'
      loop: "{{ symlinks }}"

    # --- NEW TASK: Remove default config folders ---
    # This deletes the default config folders created by package installation
    # so that we can replace them with symlinks to your dotfiles.
    - name: Clean up default config directories
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item.dest }}"
        state: absent
      loop: "{{ symlinks }}"

    # --- STEP 4: Link Dotfiles ---
    - name: Create Symlinks
      file:
        src: "{{ dotfiles_dir }}/{{ item.src }}"
        dest: "/home/{{ ansible_facts.user_id }}/{{ item.dest }}"
        state: link
        force: yes
      loop: "{{ symlinks }}"

    # --- STEP 5: LazyVim Setup ---
    - name: Back up existing Nvim config (if any)
      command: mv /home/{{ ansible_facts.user_id }}/.config/nvim /home/{{ ansible_facts.user_id }}/.config/nvim.bak
      args:
        removes: /home/{{ ansible_facts.user_id }}/.config/nvim
        creates: /home/{{ ansible_facts.user_id }}/.config/nvim.bak

    - name: Install LazyVim (Clone Starter Repo)
      git:
        repo: https://github.com/LazyVim/starter
        dest: /home/{{ ansible_facts.user_id }}/.config/nvim
        depth: 1

    # --- STEP 6: System Services & Tweaks ---
    - name: Enable essential services
      become: true
      systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - NetworkManager      # Internet
        - bluetooth           # Bluetooth
        - fstrim.timer        # CRITICAL for SSD health (runs weekly)

# --- STEP 7: SDDM (Login Screen) ---
    
    # 1. Install SDDM (Needs Root)
    - name: Install SDDM
      become: true
      community.general.pacman:
        name: sddm
        state: present

    # 2. Install Theme (MUST RUN AS USER, NOT ROOT)
    - name: Install SDDM Theme (Catppuccin)
      become: false   # <--- This fixes the error
      kewlfft.aur.aur:
        name: sddm-catppuccin-git
        use: yay
        state: present

    # 3. Configure SDDM to use the theme (Needs Root)
    - name: Create SDDM config directory
      become: true
      file:
        path: /etc/sddm.conf.d
        state: directory

    - name: Set SDDM Theme to Catppuccin
      become: true
      copy:
        dest: /etc/sddm.conf.d/theme.conf
        content: |
          [Theme]
          Current=catppuccin-mocha

    # 4. Enable Service (Needs Root)
    - name: Enable SDDM Service
      become: true
      systemd:
        name: sddm
        enabled: true
        state: started

    # --- STEP 6: Apply Dark Theme (GTK) ---
    - name: Ensure GTK-3.0 directory exists
      file:
        path: "/home/{{ ansible_facts.user_id }}/.config/gtk-3.0"
        state: directory
        mode: '0755'

    - name: Configure GTK Dark Theme (Nemo/Firefox)
      copy:
        dest: "/home/{{ ansible_facts.user_id }}/.config/gtk-3.0/settings.ini"
        content: |
          [Settings]
          gtk-theme-name=Catppuccin-Mocha-Standard-Mauve-Dark
          gtk-icon-theme-name=Dracula
          gtk-font-name=Sans 11
          gtk-cursor-theme-name=Catppuccin-Mocha-Dark-Cursors
          gtk-cursor-theme-size=24
          gtk-toolbar-style=GTK_TOOLBAR_BOTH
          gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
          gtk-button-images=1
          gtk-menu-images=1
          gtk-enable-event-sounds=1
          gtk-enable-input-feedback-sounds=1
          gtk-xft-antialias=1
          gtk-xft-hinting=1
          gtk-xft-hintstyle=hintfull
          gtk-application-prefer-dark-theme=1
