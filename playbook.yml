---
- name: Arch Linux Setup
  hosts: localhost
  connection: local
  
  # ----------------------------------------------------------------
  # VARIABLES: Edit these lists to customize your setup
  # ----------------------------------------------------------------
  vars:
    # 1. The folder where your dotfiles are currently located (Source)
    #    If you cloned your repo to ~/dotfiles, leave as is.
    dotfiles_dir: "/home/{{ ansible_facts.user_id }}/dotfiles"
    dotfiles_repo_url: "https://github.com/ajcraig99/arch_hypr_dotfiles.git" 

    # 2. Official Arch Packages (Pacman)
    pacman_packages:

# --- System / Build ---
      - base-devel
      - go
      - git
      - neovim
      - tree
      - fastfetch
      - btop
      - unzip
      - man-db
      - usbutils
      - bluez
      - bluez-utils
      - wget
      - nwg-displays
      - networkmanager
      - timeshift
      - cronie

      # --- Audio / Media ---
      - pipewire
      - pipewire-pulse
      - pavucontrol
      - ffmpeg
      - vlc
      - mpv
      - gthumb
      - loupe
      - gimp
      - inkscape
      - yt-dlp

      # --- Hyprland & Wayland Core ---
      - hyprland
      - hyprpaper
      - hyprlock
      - hypridle
      - waybar
      - rofi-wayland          
      - swaync               
      - wl-clipboard
      - grim
      - slurp
      - libnotify
      - playerctl

      # --- File Management ---
      - dolphin
      - nemo
      - nemo-fileroller       
      - file-roller          
      - gvfs
      - tumbler
      - webp-pixbuf-loader

      # --- Shell / Terminal ---
      - kitty
      - zsh
      - zsh-autosuggestions
      - zsh-syntax-highlighting
      - fzf
      - bat
      - eza
      - ttf-jetbrains-mono-nerd

      # --- Apps ---
      - firefox
      - discord
      - steam
      - obsidian
      - gnome-calendar
      - simple-scan
      - jq
      - socat
      
      # --- SDDM & Qt Dependencies ---
      - sddm
      - qt5-declarative
      - qt5-quickcontrols        # QtQuick.Controls 1.x (REQUIRED for Chili theme!)
      - qt5-quickcontrols2       # QtQuick.Controls 2.x (for other themes)
      - qt5-graphicaleffects
      - qt5-svg
      
      # --- Storage Management ---
      - cifs-utils              # For SMB/CIFS shares
      - ntfs-3g                 # For NTFS drives
      - exfatprogs              # For exFAT drives

    # 3. AUR Packages (Yay)
    aur_packages:
      - google-chrome
      - visual-studio-code-bin
      - vesktop-bin
      - smath
      - wlogout
      - grimblast-git
      - onlyoffice-bin
      - peazip-qt-bin
      - waybar-module-pacman-updates-git
      - zsh-theme-powerlevel10k-git

      # --- Theming ---
      - catppuccin-gtk-theme-mocha
      - catppuccin-cursors-mocha
      - dracula-gtk-theme
      - dracula-icons-git
      
    symlinks:
# Folders
      - { src: '.config/hypr',      dest: '.config/hypr' }
      - { src: '.config/waybar',    dest: '.config/waybar' }
      - { src: '.config/rofi',      dest: '.config/rofi' }
      - { src: '.config/kitty',     dest: '.config/kitty' }
      - { src: '.config/fastfetch', dest: '.config/fastfetch' }
      - { src: '.config/nemo',      dest: '.config/nemo' }
      - { src: '.config/wlogout',   dest: '.config/wlogout' }
      - { src: '.config/wallpapers', dest: '.config/wallpapers' }
      
      # Individual Files
      - { src: '.zshrc',            dest: '.zshrc' }
      - { src: '.p10k.zsh',         dest: '.p10k.zsh' }

  # ----------------------------------------------------------------
  # TASKS: The logic that applies the variables above
  # ----------------------------------------------------------------
  tasks:

   # --- PRE-REQ: Enable Multilib (Needed for Steam) ---
    - name: Enable Multilib repository
      become: true
      replace:
        path: /etc/pacman.conf
        regexp: '^#\[multilib\]\n#Include = /etc/pacman.d/mirrorlist'
        replace: '[multilib]\nInclude = /etc/pacman.d/mirrorlist'

    # --- PRE-REQ: Remove PulseAudio (Conflicts with Pipewire) ---
    - name: Remove conflicting PulseAudio packages
      become: true
      community.general.pacman:
        name:
          - pulseaudio
          - pulseaudio-alsa
          - pulseaudio-bluetooth
        state: absent
        force: yes

    # --- STEP 1: Install Official Packages ---
    - name: Install Pacman packages
      become: true  # Requires sudo
      community.general.pacman:
        name: "{{ pacman_packages }}"
        state: present
        update_cache: true

    # --- PRE-REQ: Install Yay (AUR Helper) ---
    - name: Check if yay is installed
      command: which yay
      register: yay_check
      ignore_errors: true
      changed_when: false

    - name: Clone yay AUR repo
      git:
        repo: https://aur.archlinux.org/yay.git
        dest: /tmp/yay
      when: yay_check.rc != 0

    - name: Build and install yay
      command: makepkg -s --noconfirm
      args:
        chdir: /tmp/yay
      when: yay_check.rc != 0
      become: false

    - name: Install yay (install binary)
      shell: pacman -U --noconfirm *.pkg.tar.zst
      args:
        chdir: /tmp/yay
      when: yay_check.rc != 0
      become: true

    # --- Clone Dotfiles
    - name: Clone Dotfiles Repository
      git:
        repo: "{{ dotfiles_repo_url }}"
        dest: "{{ dotfiles_dir }}"
        update: yes
        force: yes

    # 1. Allow 'sudo pacman' without a password temporarily
    - name: Allow passwordless sudo for pacman
      become: true
      lineinfile:
        path: /etc/sudoers.d/10-ansible-pacman
        line: "{{ ansible_facts.user_id }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    # --- STEP 2: Install AUR Packages ---
    - name: Install AUR packages
      kewlfft.aur.aur:
        name: "{{ aur_packages }}"
        use: yay
        state: present

    # 3. Clean up the permission file
    - name: Remove passwordless sudo for pacman
      become: true
      file:
        path: /etc/sudoers.d/10-ansible-pacman
        state: absent
        
# --- STEP 3: Create Directories ---
    - name: Ensure parent directories for configs exist
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item.dest | dirname }}"
        state: directory
        mode: '0755'
      loop: "{{ symlinks }}"

    # --- NEW TASK: Remove default config folders ---
    # This deletes the default config folders created by package installation
    # so that we can replace them with symlinks to your dotfiles.
    - name: Clean up default config directories
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item.dest }}"
        state: absent
      loop: "{{ symlinks }}"

    # --- STEP 4: Link Dotfiles ---
    - name: Create Symlinks
      file:
        src: "{{ dotfiles_dir }}/{{ item.src }}"
        dest: "/home/{{ ansible_facts.user_id }}/{{ item.dest }}"
        state: link
        force: yes
      loop: "{{ symlinks }}"

    # --- STEP 5: NvChad Setup ---
    - name: Back up existing Nvim config (if any)
      command: mv /home/{{ ansible_facts.user_id }}/.config/nvim /home/{{ ansible_facts.user_id }}/.config/nvim.bak
      args:
        removes: /home/{{ ansible_facts.user_id }}/.config/nvim
        creates: /home/{{ ansible_facts.user_id }}/.config/nvim.bak
      ignore_errors: yes

    - name: Clean Neovim data directories
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item }}"
        state: absent
      loop:
        - .local/share/nvim
        - .local/state/nvim
        - .cache/nvim
      ignore_errors: yes

    - name: Install NvChad (Clone Starter Repo)
      git:
        repo: https://github.com/NvChad/starter
        dest: /home/{{ ansible_facts.user_id }}/.config/nvim
        depth: 1

    # --- STEP 6: System Services & Tweaks ---
    - name: Enable essential services
      become: true
      systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - NetworkManager      # Internet
        - bluetooth           # Bluetooth
        - fstrim.timer        # CRITICAL for SSD health (runs weekly)

    # --- STEP 7: SDDM with Chili Theme ---
    - name: Extract Chili theme to SDDM themes directory
      become: true
      unarchive:
        src: "{{ dotfiles_dir }}/.config/sddm/sddm-chili.tar.gz"
        dest: /usr/share/sddm/themes/
        owner: root
        group: root
        creates: /usr/share/sddm/themes/chili/Main.qml

    - name: Create SDDM config directory
      become: true
      file:
        path: /etc/sddm.conf.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure SDDM to use Chili theme
      become: true
      community.general.ini_file:
        path: /etc/sddm.conf.d/theme.conf
        section: Theme
        option: Current
        value: chili
        owner: root
        group: root
        mode: '0644'
        create: yes
      notify: restart sddm

    - name: Enable SDDM Service
      become: true
      systemd:
        name: sddm
        enabled: true

    # --- STEP 8: Apply Dark Theme (GTK) ---
    - name: Ensure GTK-3.0 directory exists
      file:
        path: "/home/{{ ansible_facts.user_id }}/.config/gtk-3.0"
        state: directory
        mode: '0755'

    - name: Configure GTK Dark Theme (Nemo/Firefox)
      copy:
        dest: "/home/{{ ansible_facts.user_id }}/.config/gtk-3.0/settings.ini"
        content: |
          [Settings]
          gtk-theme-name=Catppuccin-Mocha-Standard-Mauve-Dark
          gtk-icon-theme-name=Dracula
          gtk-font-name=Sans 11
          gtk-cursor-theme-name=Catppuccin-Mocha-Dark-Cursors
          gtk-cursor-theme-size=24
          gtk-toolbar-style=GTK_TOOLBAR_BOTH
          gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
          gtk-button-images=1
          gtk-menu-images=1
          gtk-enable-event-sounds=1
          gtk-enable-input-feedback-sounds=1
          gtk-xft-antialias=1
          gtk-xft-hinting=1
          gtk-xft-hintstyle=hintfull
          gtk-application-prefer-dark-theme=1
    
    - name: Check if Nemo dconf settings exist
      stat:
        path: "{{ dotfiles_dir }}/.config/nemo/nemo-settings.dconf"
      register: nemo_dconf

    - name: Restore Nemo dconf settings
      command: dconf load /org/nemo/ < {{ dotfiles_dir }}/.config/nemo/nemo-settings.dconf
      when: nemo_dconf.stat.exists

    changed_when: false    
    - name: Install Timeshift
      become: true
      community.general.pacman:
        name:
          - timeshift
          - cronie
        state: present

    - name: Enable cronie for scheduled backups
      become: true
      systemd:
        name: cronie
        enabled: true
        state: started   

    - name: Install xdg-user-dirs
      become: true
      community.general.pacman:
        name: xdg-user-dirs
        state: present

    - name: Create XDG user directories
      command: xdg-user-dirs-update
      changed_when: false

    - name: Display Timeshift setup info
      debug:
        msg: |
          
          ====================================
          Timeshift Installed
          ====================================
          
          To configure Timeshift:
            sudo timeshift-gtk
          
          Or run from application menu: "Timeshift"
          
          Recommended:
          1. Select BTRFS or RSYNC mode
          2. Choose snapshot location
          3. Set up automatic snapshots schedule 
  # ----------------------------------------------------------------
  # HANDLERS: Actions triggered by notify
  # ----------------------------------------------------------------
  handlers:
    - name: restart sddm
      become: true
      systemd:
        name: sddm.service
        state: restarted
