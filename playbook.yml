---
- name: Arch Linux Setup
  hosts: localhost
  connection: local
  
  # ----------------------------------------------------------------
  # VARIABLES: Edit these lists to customize your setup
  # ----------------------------------------------------------------
  vars:
    # 1. The folder where your dotfiles are currently located (Source)
    #    If you cloned your repo to ~/dotfiles, leave as is.
    dotfiles_dir: "/home/{{ ansible_facts.user_id }}/dotfiles"
    dotfiles_repo_url: "https://github.com/ajcraig99/arch_hypr_dotfiles.git" 

    # 2. Official Arch Packages (Pacman)
    pacman_packages:

# --- System / Build ---
      - base-devel
      - go
      - git
      - neovim
      - tree
      - fastfetch
      - btop
      - unzip
      - man-db
      - usbutils
      - bluez
      - bluez-utils
      - wget
      - nwg-displays
      - networkmanager 

      # --- Audio / Media ---
      - pipewire
      - pipewire-pulse
      - pavucontrol
      - ffmpeg
      - vlc
      - mpv
      - gthumb
      - loupe
      - gimp
      - inkscape
      - yt-dlp

      # --- Hyprland & Wayland Core ---
      - hyprland
      - hyprpaper
      - hyprlock
      - hypridle
      - waybar
      - rofi-wayland          
      - swaync               
      - wl-clipboard
      - grim
      - slurp
      - libnotify
      - playerctl

      # --- File Management ---
      - dolphin
      - nemo
      - nemo-fileroller       
      - file-roller          
      - gvfs
      - tumbler
      - webp-pixbuf-loader

      # --- Shell / Terminal ---
      - kitty
      - zsh
      - zsh-autosuggestions
      - zsh-syntax-highlighting
      - fzf
      - bat
      - eza
      - ttf-jetbrains-mono-nerd

      # --- Apps ---
      - firefox
      - discord
      - steam
      - obsidian
      - gnome-calendar
      - simple-scan
      - jq
      - socat
      
      # --- SDDM & Qt Dependencies ---
      - sddm
      - qt5-declarative
      - qt5-quickcontrols        # QtQuick.Controls 1.x (REQUIRED for Chili theme!)
      - qt5-quickcontrols2       # QtQuick.Controls 2.x (for other themes)
      - qt5-graphicaleffects
      - qt5-svg
      
      # --- Storage Management ---
      - cifs-utils              # For SMB/CIFS shares
      - ntfs-3g                 # For NTFS drives
      - exfatprogs              # For exFAT drives

    # 3. AUR Packages (Yay)
    aur_packages:
      - google-chrome
      - visual-studio-code-bin
      - vesktop-bin
      - smath
      - wlogout
      - grimblast-git
      - onlyoffice-bin
      - peazip-qt-bin
      - waybar-module-pacman-updates-git
      - zsh-theme-powerlevel10k-git

      # --- Theming ---
      - catppuccin-gtk-theme-mocha
      - catppuccin-cursors-mocha
      - dracula-gtk-theme
      - dracula-icons-git
      
    symlinks:
# Folders
      - { src: '.config/hypr',      dest: '.config/hypr' }
      - { src: '.config/waybar',    dest: '.config/waybar' }
      - { src: '.config/rofi',      dest: '.config/rofi' }
      - { src: '.config/kitty',     dest: '.config/kitty' }
      - { src: '.config/fastfetch', dest: '.config/fastfetch' }
      - { src: '.config/nemo',      dest: '.config/nemo' }
      - { src: '.config/wlogout',   dest: '.config/wlogout' }
      - { src: '.config/wallpapers', dest: '.config/wallpapers' }
      
      # Individual Files
      - { src: '.zshrc',            dest: '.zshrc' }
      - { src: '.p10k.zsh',         dest: '.p10k.zsh' }

  # ----------------------------------------------------------------
  # TASKS: The logic that applies the variables above
  # ----------------------------------------------------------------
  tasks:

   # --- PRE-REQ: Enable Multilib (Needed for Steam) ---
    - name: Enable Multilib repository
      become: true
      replace:
        path: /etc/pacman.conf
        regexp: '^#\[multilib\]\n#Include = /etc/pacman.d/mirrorlist'
        replace: '[multilib]\nInclude = /etc/pacman.d/mirrorlist'

    # --- PRE-REQ: Remove PulseAudio (Conflicts with Pipewire) ---
    - name: Remove conflicting PulseAudio packages
      become: true
      community.general.pacman:
        name:
          - pulseaudio
          - pulseaudio-alsa
          - pulseaudio-bluetooth
        state: absent
        force: yes

    # --- STEP 1: Install Official Packages ---
    - name: Install Pacman packages
      become: true  # Requires sudo
      community.general.pacman:
        name: "{{ pacman_packages }}"
        state: present
        update_cache: true

    # --- PRE-REQ: Install Yay (AUR Helper) ---
    - name: Check if yay is installed
      command: which yay
      register: yay_check
      ignore_errors: true
      changed_when: false

    - name: Clone yay AUR repo
      git:
        repo: https://aur.archlinux.org/yay.git
        dest: /tmp/yay
      when: yay_check.rc != 0

    - name: Build and install yay
      command: makepkg -s --noconfirm
      args:
        chdir: /tmp/yay
      when: yay_check.rc != 0
      become: false

    - name: Install yay (install binary)
      shell: pacman -U --noconfirm *.pkg.tar.zst
      args:
        chdir: /tmp/yay
      when: yay_check.rc != 0
      become: true

    # --- Clone Dotfiles
    - name: Clone Dotfiles Repository
      git:
        repo: "{{ dotfiles_repo_url }}"
        dest: "{{ dotfiles_dir }}"
        update: yes
        force: yes

    # 1. Allow 'sudo pacman' without a password temporarily
    - name: Allow passwordless sudo for pacman
      become: true
      lineinfile:
        path: /etc/sudoers.d/10-ansible-pacman
        line: "{{ ansible_facts.user_id }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    # --- STEP 2: Install AUR Packages ---
    - name: Install AUR packages
      kewlfft.aur.aur:
        name: "{{ aur_packages }}"
        use: yay
        state: present

    # 3. Clean up the permission file
    - name: Remove passwordless sudo for pacman
      become: true
      file:
        path: /etc/sudoers.d/10-ansible-pacman
        state: absent
        
# --- STEP 3: Create Directories ---
    - name: Ensure parent directories for configs exist
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item.dest | dirname }}"
        state: directory
        mode: '0755'
      loop: "{{ symlinks }}"

    # --- NEW TASK: Remove default config folders ---
    # This deletes the default config folders created by package installation
    # so that we can replace them with symlinks to your dotfiles.
    - name: Clean up default config directories
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item.dest }}"
        state: absent
      loop: "{{ symlinks }}"

    # --- STEP 4: Link Dotfiles ---
    - name: Create Symlinks
      file:
        src: "{{ dotfiles_dir }}/{{ item.src }}"
        dest: "/home/{{ ansible_facts.user_id }}/{{ item.dest }}"
        state: link
        force: yes
      loop: "{{ symlinks }}"

    # --- STEP 5: NvChad Setup ---
    - name: Back up existing Nvim config (if any)
      command: mv /home/{{ ansible_facts.user_id }}/.config/nvim /home/{{ ansible_facts.user_id }}/.config/nvim.bak
      args:
        removes: /home/{{ ansible_facts.user_id }}/.config/nvim
        creates: /home/{{ ansible_facts.user_id }}/.config/nvim.bak
      ignore_errors: yes

    - name: Clean Neovim data directories
      file:
        path: "/home/{{ ansible_facts.user_id }}/{{ item }}"
        state: absent
      loop:
        - .local/share/nvim
        - .local/state/nvim
        - .cache/nvim
      ignore_errors: yes

    - name: Install NvChad (Clone Starter Repo)
      git:
        repo: https://github.com/NvChad/starter
        dest: /home/{{ ansible_facts.user_id }}/.config/nvim
        depth: 1

    # --- STEP 6: System Services & Tweaks ---
    - name: Enable essential services
      become: true
      systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - NetworkManager      # Internet
        - bluetooth           # Bluetooth
        - fstrim.timer        # CRITICAL for SSD health (runs weekly)

    # --- STEP 7: SDDM with Chili Theme ---
    - name: Extract Chili theme to SDDM themes directory
      become: true
      unarchive:
        src: "{{ dotfiles_dir }}/.config/sddm/sddm-chili.tar.gz"
        dest: /usr/share/sddm/themes/
        owner: root
        group: root
        creates: /usr/share/sddm/themes/chili/Main.qml

    - name: Create SDDM config directory
      become: true
      file:
        path: /etc/sddm.conf.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure SDDM to use Chili theme
      become: true
      community.general.ini_file:
        path: /etc/sddm.conf.d/theme.conf
        section: Theme
        option: Current
        value: chili
        owner: root
        group: root
        mode: '0644'
        create: yes
      notify: restart sddm

    - name: Enable SDDM Service
      become: true
      systemd:
        name: sddm
        enabled: true

    # --- STEP 8: Apply Dark Theme (GTK) ---
    - name: Ensure GTK-3.0 directory exists
      file:
        path: "/home/{{ ansible_facts.user_id }}/.config/gtk-3.0"
        state: directory
        mode: '0755'

    - name: Configure GTK Dark Theme (Nemo/Firefox)
      copy:
        dest: "/home/{{ ansible_facts.user_id }}/.config/gtk-3.0/settings.ini"
        content: |
          [Settings]
          gtk-theme-name=Catppuccin-Mocha-Standard-Mauve-Dark
          gtk-icon-theme-name=Dracula
          gtk-font-name=Sans 11
          gtk-cursor-theme-name=Catppuccin-Mocha-Dark-Cursors
          gtk-cursor-theme-size=24
          gtk-toolbar-style=GTK_TOOLBAR_BOTH
          gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
          gtk-button-images=1
          gtk-menu-images=1
          gtk-enable-event-sounds=1
          gtk-enable-input-feedback-sounds=1
          gtk-xft-antialias=1
          gtk-xft-hinting=1
          gtk-xft-hintstyle=hintfull
          gtk-application-prefer-dark-theme=1

    # --- STEP 9: Storage Configuration (External Drives & SMB Shares) ---
    - name: Create fstab manager script
      become: true
      copy:
        dest: /usr/local/bin/fstab-manager
        mode: '0755'
        owner: root
        group: root
        content: |
          #!/usr/bin/env bash
          # fstab-manager.sh - Interactive fstab configuration tool
          set -e
          
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'
          
          print_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
          print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
          print_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
          print_error() { echo -e "${RED}[ERROR]${NC} $1"; }
          
          check_root() {
              if [[ $EUID -ne 0 ]]; then
                  print_error "This script must be run as root (use sudo)"
                  exit 1
              fi
          }
          
          backup_fstab() {
              BACKUP="/etc/fstab.backup.$(date +%Y%m%d_%H%M%S)"
              print_info "Backing up /etc/fstab to $BACKUP"
              cp /etc/fstab "$BACKUP"
              print_success "Backup created"
          }
          
          list_block_devices() {
              print_info "Available block devices:"
              echo ""
              lsblk -o NAME,SIZE,TYPE,FSTYPE,LABEL,UUID,MOUNTPOINT | grep -E "disk|part"
              echo ""
          }
          
          uuid_in_fstab() {
              grep -q "UUID=$1" /etc/fstab
          }
          
          add_external_hdd() {
              print_info "=== Add External Hard Drive ==="
              echo ""
              list_block_devices
              echo ""
              read -p "Enter device name (e.g., sdb1) or 'skip': " device
              
              [[ "$device" == "skip" ]] && return
              [[ ! -b "/dev/$device" ]] && print_error "Device /dev/$device does not exist" && return
              
              UUID=$(blkid -s UUID -o value /dev/$device)
              FSTYPE=$(blkid -s TYPE -o value /dev/$device)
              LABEL=$(blkid -s LABEL -o value /dev/$device 2>/dev/null || echo "")
              
              [[ -z "$UUID" ]] && print_error "Could not determine UUID" && return
              
              if uuid_in_fstab "$UUID"; then
                  print_warning "UUID=$UUID already in fstab"
                  read -p "Continue anyway? (y/n): " cont
                  [[ "$cont" != "y" ]] && return
              fi
              
              print_info "Device: /dev/$device | UUID: $UUID | Type: $FSTYPE"
              [[ -n "$LABEL" ]] && print_info "Label: $LABEL"
              
              echo ""
              read -p "Mount point (e.g., /mnt/external): " mountpoint
              mountpoint=${mountpoint%/}
              [[ -z "$mountpoint" ]] && print_error "Mount point required" && return
              
              [[ ! -d "$mountpoint" ]] && mkdir -p "$mountpoint"
              
              case "$FSTYPE" in
                  ntfs) mount_opts="defaults,nofail,uid=1000,gid=1000,umask=022" ;;
                  exfat|vfat) mount_opts="defaults,nofail,uid=1000,gid=1000,umask=022" ;;
                  ext4|ext3) mount_opts="defaults,nofail" ;;
                  btrfs) mount_opts="defaults,nofail,compress=zstd" ;;
                  *) mount_opts="defaults,nofail" ;;
              esac
              
              print_info "Mount options: $mount_opts"
              read -p "Use these? (y/n): " use_opts
              [[ "$use_opts" != "y" ]] && read -p "Custom options: " mount_opts
              
              echo "" >> /etc/fstab
              echo "# External HDD - $device ($(date))" >> /etc/fstab
              echo "UUID=$UUID $mountpoint $FSTYPE $mount_opts 0 2" >> /etc/fstab
              print_success "Added to fstab"
              
              read -p "Mount now? (y/n): " mount_now
              [[ "$mount_now" == "y" ]] && mount "$mountpoint" && print_success "Mounted"
          }
          
          add_smb_share() {
              print_info "=== Add SMB/CIFS Share ==="
              echo ""
              
              read -p "SMB server IP/hostname: " smb_server
              [[ -z "$smb_server" ]] && print_error "Server required" && return
              
              read -p "Share name: " share_name
              [[ -z "$share_name" ]] && print_error "Share name required" && return
              
              read -p "Mount point (e.g., /mnt/nas): " mountpoint
              mountpoint=${mountpoint%/}
              [[ -z "$mountpoint" ]] && print_error "Mount point required" && return
              
              [[ ! -d "$mountpoint" ]] && mkdir -p "$mountpoint"
              
              read -p "SMB username: " smb_user
              [[ -z "$smb_user" ]] && print_error "Username required" && return
              
              read -s -p "SMB password: " smb_pass
              echo ""
              [[ -z "$smb_pass" ]] && print_error "Password required" && return
              
              CREDS_FILE="/root/.smb_credentials_$(echo $share_name | tr '/' '_')"
              cat > "$CREDS_FILE" <<EOF
          username=$smb_user
          password=$smb_pass
          EOF
              chmod 600 "$CREDS_FILE"
              print_success "Credentials saved to $CREDS_FILE"
              
              mount_opts="credentials=$CREDS_FILE,vers=3.0,uid=1000,gid=1000,file_mode=0755,dir_mode=0755,nofail"
              
              echo "" >> /etc/fstab
              echo "# SMB - //$smb_server/$share_name ($(date))" >> /etc/fstab
              echo "//$smb_server/$share_name $mountpoint cifs $mount_opts 0 0" >> /etc/fstab
              print_success "Added to fstab"
              
              read -p "Mount now? (y/n): " mount_now
              [[ "$mount_now" == "y" ]] && mount "$mountpoint" && print_success "Mounted"
          }
          
          show_fstab() {
              print_info "Current /etc/fstab:"
              echo ""
              cat -n /etc/fstab
              echo ""
          }
          
          test_fstab() {
              print_info "Testing fstab..."
              if mount -a --fake; then
                  print_success "Syntax valid"
              else
                  print_error "Syntax errors found"
              fi
          }
          
          main_menu() {
              while true; do
                  echo ""
                  echo "========================================"
                  echo "  Fstab Manager"
                  echo "========================================"
                  echo ""
                  echo "1) Add External Hard Drive"
                  echo "2) Add SMB/CIFS Network Share"
                  echo "3) Show current fstab"
                  echo "4) Test fstab"
                  echo "5) Mount all"
                  echo "6) Exit"
                  echo ""
                  read -p "Choose [1-6]: " choice
                  
                  case "$choice" in
                      1)
                          add_external_hdd
                          read -p "Add another? (y/n): " another
                          while [[ "$another" == "y" ]]; do
                              add_external_hdd
                              read -p "Add another? (y/n): " another
                          done
                          ;;
                      2)
                          add_smb_share
                          read -p "Add another? (y/n): " another
                          while [[ "$another" == "y" ]]; do
                              add_smb_share
                              read -p "Add another? (y/n): " another
                          done
                          ;;
                      3) show_fstab ;;
                      4) test_fstab ;;
                      5) mount -a && print_success "All mounted" ;;
                      6) exit 0 ;;
                      *) print_error "Invalid option" ;;
                  esac
              done
          }
          
          check_root
          backup_fstab
          main_menu
      tags: storage

    - name: Create fstab manager desktop entry
      copy:
        dest: "/home/{{ ansible_facts.user_id }}/.local/share/applications/fstab-manager.desktop"
        content: |
          [Desktop Entry]
          Name=Fstab Manager
          Comment=Configure external drives and network shares
          Exec=kitty sudo /usr/local/bin/fstab-manager
          Icon=drive-harddisk
          Terminal=true
          Type=Application
          Categories=System;Settings;
        mode: '0644'
      tags: storage

    - name: Prompt for storage configuration
      pause:
        prompt: |
          
          ========================================
          Configure Drives & SMB Shares?
          ========================================
          
          Interactive tool to:
          • Detect and mount external drives
          • Configure SMB/CIFS network shares
          • Auto-update /etc/fstab
          
          'y' = Configure now
          'n' = Skip (run 'sudo fstab-manager' later)
          
          Configure? (y/n)
      register: configure_storage
      tags: storage

    - name: Run fstab manager
      become: true
      command: /usr/local/bin/fstab-manager
      when: configure_storage.user_input | lower == 'y'
      tags: storage

    - name: Display final message
      debug:
        msg: |
          
          ========================================
          Setup Complete!
          ========================================
          
          {% if configure_storage.user_input | lower == 'y' %}
          ✓ Storage configured
          {% else %}
          Configure drives later: sudo fstab-manager
          {% endif %}
          
          Useful commands:
          • Mount all:  sudo mount -a
          • Check fstab: sudo mount -a --fake
          • View fstab:  cat /etc/fstab
          
          Reboot to start SDDM login manager!
      tags: storage

  # ----------------------------------------------------------------
  # HANDLERS: Actions triggered by notify
  # ----------------------------------------------------------------
  handlers:
    - name: restart sddm
      become: true
      systemd:
        name: sddm.service
        state: restarted
